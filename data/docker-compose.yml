version: "3.1"

services:
  heatmap-tiles-service:
    image: bikedataproject/heatmap-tiles-service:staging
    volumes:
      - /var/services/heatmap/db-fixed:/var/app/data
      - /var/services/heatmap/tiles-fixed:/var/app/tiles
      - /var/services/heatmap/logs:/var/app/logs
    environment:
      BIKEDATA_DB: /run/secrets/db_connection_string
    secrets:
      - db_connection_string
  virtual-traffic-count:
    image: anywaysopen/traffic-count-api:prod
    volumes:
      - /var/services/shared/virtual-traffic/:/var/app/data/
      - /var/services/logs/virtual-traffic-counts/:/var/app/logs/
      - /var/services/deployment/data/config/virtual-traffic-count:/var/app/config
    ports:
      - 5006:5000
  virtual-traffic-mapmatching:
    image: anywaysopen/traffic-count-mapmatching:prod
    volumes:
      - /var/services/virtual-traffic-mapmatching/data/:/var/app/data/
      - /var/services/logs/virtual-traffic-mapmatching/:/var/app/logs/
      - /var/services/shared/virtual-traffic/:/var/app/output/
      - /var/services/deployment/data/config/virtual-traffic-mapmatching:/var/app/config
    environment:
      BIKEDATA_DB: /run/secrets/db_connection_string
    secrets:
      - db_connection_string
  virtual-traffic-dump:
    image: anywaysopen/traffic-count-dump:prod
    volumes:
      - /var/services/virtual-traffic-dump/data/:/var/app/data/
      - /var/services/shared/virtual-traffic/:/var/app/input/
      - /var/services/files/counts/:/var/app/output/
      - /var/services/logs/virtual-traffic-dump/:/var/app/logs/
      - /var/services/deployment/data/config/virtual-traffic-dump:/var/app/config
  integrations-osm-gpx-db:
    image: anywaysopen/postgres:11
    volumes:
      - /var/services/integrations-osm-gpx-db/db:/var/lib/postgresql/data
      - /var/services/integrations-osm-gpx-db/dumps/:/var/lib/postgresql/dumps
    ports:
      - 5007:5432
    environment:
      POSTGRES_PASSWORD_FILE: /run/secrets/integrations-osm-gpx-db-password
    secrets:
      - integrations-osm-gpx-db-password

secrets:
  db_connection_string:
    external: true
  integrations-osm-gpx-db-password:
    external: true
      

